# CloudClaude 高階系統架構

## 系統概覽

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           通訊軟體層                                     │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                     │
│  │  LINE   │  │  Slack  │  │ Discord │  │Telegram │                     │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                     │
└───────┼────────────┼────────────┼────────────┼──────────────────────────┘
        │            │            │            │
        ▼            ▼            ▼            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Webhook Receiver (Serverless)                       │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  - 接收各通訊軟體的 webhook                                         │ │
│  │  - 驗證請求來源                                                     │ │
│  │  - 將訊息寫入 Message Queue                                         │ │
│  │  - 立即回應 200 OK（避免 timeout）                                  │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Message Queue                                   │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  - 暫存所有進入的訊息                                               │ │
│  │  - 確保訊息不遺失                                                   │ │
│  │  - 支援大量訊息湧入                                                 │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       Router / 總機 (Serverless)                         │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  - 從 Queue 取出訊息處理                                            │ │
│  │  - 查詢 channel 與 VM 的對應關係                                    │ │
│  │  - 若無對應 VM：由總機 Claude 直接處理（建立專案、環境等）           │ │
│  │  - 若有對應 VM：轉發訊息至該 VM                                     │ │
│  │  - 處理 streaming 回應（若通訊軟體支援）                            │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
        │
        ├──────────────────────────────────┐
        ▼                                  ▼
┌─────────────────────┐    ┌─────────────────────────────────────────────┐
│  VM Manager         │    │              Build Service                   │
│  ┌───────────────┐  │    │  ┌───────────────────────────────────────┐  │
│  │ VM 生命週期   │  │    │  │  - 建置 Docker image                  │  │
│  │ 管理          │  │    │  │  - 建立新專案結構                     │  │
│  └───────────────┘  │    │  │  - Push image 到 Registry             │  │
│  ┌───────────────┐  │    │  └───────────────────────────────────────┘  │
│  │ 對應關係維護  │  │    └─────────────────────────────────────────────┘
│  └───────────────┘  │
│  ┌───────────────┐  │
│  │ 閒置資源管理  │  │
│  └───────────────┘  │
└─────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            VM Pool                                       │
│                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │
│  │      VM 1       │  │      VM 2       │  │      VM N       │          │
│  │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │          │
│  │  │  Docker   │  │  │  │  Docker   │  │  │  │  Docker   │  │          │
│  │  │ Container │  │  │  │ Container │  │  │  │ Container │  │          │
│  │  │┌─────────┐│  │  │  │┌─────────┐│  │  │  │┌─────────┐│  │          │
│  │  ││Claude   ││  │  │  ││Claude   ││  │  │  ││Claude   ││  │          │
│  │  ││Code     ││  │  │  ││Code     ││  │  │  ││Code     ││  │          │
│  │  │└─────────┘│  │  │  │└─────────┘│  │  │  │└─────────┘│  │          │
│  │  │┌─────────┐│  │  │  │┌─────────┐│  │  │  │┌─────────┐│  │          │
│  │  ││開發環境 ││  │  │  ││開發環境 ││  │  │  ││開發環境 ││  │          │
│  │  │└─────────┘│  │  │  │└─────────┘│  │  │  │└─────────┘│  │          │
│  │  │┌─────────┐│  │  │  │┌─────────┐│  │  │  │┌─────────┐│  │          │
│  │  ││GitHub   ││  │  │  ││GitHub   ││  │  │  ││GitHub   ││  │          │
│  │  ││Repo     ││  │  │  ││Repo     ││  │  │  ││Repo     ││  │          │
│  │  │└─────────┘│  │  │  │└─────────┘│  │  │  │└─────────┘│  │          │
│  │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │          │
│  │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │          │
│  │  │ 對話儲存  │  │  │  │ 對話儲存  │  │  │  │ 對話儲存  │  │          │
│  │  │(per 群組) │  │  │  │(per 群組) │  │  │  │(per 群組) │  │          │
│  │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │          │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## 元件說明

### 通訊軟體層
負責與終端用戶互動的介面，支援 LINE、Slack、Discord、Telegram。

### Webhook Receiver (Serverless)
- 接收各通訊軟體的 webhook 請求
- 驗證請求來源（防止偽造）
- 將訊息寫入 Message Queue
- 立即回應 200 OK（避免通訊軟體 timeout）

### Message Queue
- 暫存所有進入的訊息
- 確保訊息不遺失（即使後端暫時無法處理）
- 支援大量訊息湧入時的削峰

### Router (Serverless)
- 從 Queue 取出訊息處理
- 查詢用戶是否有專屬 Container（總機）
- **無 Container 時**：建立用戶專屬 Container，注入用戶的 OAuth Token
- **有 Container 時**：轉發訊息至用戶的 Container
- 查詢 channel 與 VM 的對應關係，轉發開發任務至對應 VM
- 處理 streaming 回應

### 用戶 Container（總機）
- 每個用戶一個獨立 Container
- 注入用戶的 `CLAUDE_CODE_OAUTH_TOKEN`，使用用戶訂閱額度
- 執行 Agent SDK 處理：
  - 協助用戶建立新專案
  - 協助設定開發環境
  - 觸發 Build Service 建置 Docker image
  - 一般問答
- 閒置 30 分鐘後銷毀，下次請求時重建

### Build Service
- 建置 Docker image（根據 Dockerfile）
- 建立新專案結構
- Push image 到 Container Registry

### VM Manager
- 管理 VM 生命週期（建立、啟動、停止、刪除）
- 維護對應關係：
  - 用戶 ↔ VM
  - 通訊軟體群組/頻道 ↔ VM
- 執行閒置資源節省策略

### VM Pool
每個 VM 內執行 Docker Container，包含：
- **Claude Code**：AI 對話與程式碼操作核心
- **開發環境**：依 Dockerfile 定義的環境
- **GitHub Repo**：一個或多個已 clone 的專案

VM 本機儲存：
- **對話儲存**：各群組/頻道的獨立對話記錄（持久化於 VM 磁碟）

## 資料流

### 新用戶首次對話（無對應 VM）
```
用戶訊息 → 通訊軟體 → Webhook Receiver → Message Queue
    → Router/總機 → 總機 Claude 處理 → 回應用戶
    → (若需建立環境) → Build Service → VM Manager → 建立 VM
    → 綁定 channel 與 VM → 回應用戶環境已就緒
```

### 一般對話流程（有對應 VM）
```
用戶訊息 → 通訊軟體 → Webhook Receiver → Message Queue
    → Router/總機 → 查詢對應 VM → 轉發至 VM
    → VM 內 Claude Code 處理 → 回應 → Router → 通訊軟體 → 用戶
```

### VM 管理流程
```
用戶管理指令 → Router/總機 → VM Manager
    → 執行 VM 操作 → 更新對應關係 → 回應用戶
```
